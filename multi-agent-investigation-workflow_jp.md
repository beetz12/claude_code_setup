# 複数エージェントによる調査・分析ワークフロー

## 概要

このドキュメントは、Claude Code MCP（`mcp__ccm__claude_code`）と Chat MCP（`mcp__chat__agent_communication_*`）を使用して、複数の専門エージェントを協調させ、複雑な調査・分析タスクを効率的に実行するワークフローを記述します。

**対象読者**: このドキュメントはClaude Codeが参照して、複数エージェントによる調査・分析を実行するためのガイドです。

**適用領域**: 
- 大規模コードベースの調査
- システム設計の分析
- ドキュメント統合・整理
- アーキテクチャ調査
- セキュリティ監査
- パフォーマンス分析

## ワークフローの核心原則

### 1. 適応的専門化
- **初期設計**: 4-6個の専門領域に分割
- **動的拡張**: 調査中の発見に応じてエージェント追加
- **最適配置**: 各エージェントの専門性を最大活用

### 2. 継続実行プロトコル
- **自動終了防止**: 明示的終了指示まで待機継続
- **適応的チェック**: 段階的間隔（初期2分→中期3分→後期5分）
- **タイムアウト管理**: 最大60-90分の実行時間制限

### 3. 集合知統合
- **並行調査**: 複数領域の同時進行
- **相互参照**: 発見内容の共有とクロスチェック
- **高品質統合**: Opusモデルによる最終統合

## ワークフローの構成要素

### Phase 0: 戦略設計と環境準備

#### 0.1 調査対象の分析と専門領域の特定
```
調査対象の特性分析:
- 技術的複雑さ（コード、設定、ドキュメント）
- 規模（ファイル数、ディレクトリ構造）
- 関係者（開発者、ユーザー、管理者）
- 期待される成果物

専門領域分割の例:
- コードベース調査: アーキテクチャ、API、UI、DB、インフラ
- ドキュメント整理: 設計書、仕様書、手順書、テスト資料
- セキュリティ監査: 認証、認可、データ保護、ネットワーク
```

#### 0.2 Chat MCPルーム作成
```bash
# ルーム名の命名規則: [project]-[task]-[version]
# 例: permission-investigation-v2, security-audit-v1
```

#### 0.3 エージェント役割設計テンプレート（最適化版）
```
Agent [A-Z] ([role-name]) - [専門分野]調査担当

【重要: 継続実行プロトコル】
1. タスク完了後は「TASK_COMPLETED」と報告
2. その後、適応的間隔でチャットルーム「[room-name]」をチェック:
   - 初期: 2分間隔
   - 中期: 3分間隔  
   - 後期: 5分間隔
3. coordinatorからのメッセージを確認:
   - "terminate_[agent-id]": 終了処理を実行
   - "new_task_[agent-id]": 新しいタスクを開始
   - "status_[agent-id]": 現在の状態を報告
   - 上記以外: 待機継続
4. 最大待機時間: 60分、無応答タイムアウト: 5分

【調査タスク】
[具体的な調査内容1-5項目]

【品質基準（必須）】
- COVERAGE_SCORE: 調査網羅度（0-100）
- ACCURACY_SCORE: 情報正確度（0-100）
- USABILITY_SCORE: 実用性評価（0-100）
- CONFIDENCE_LEVEL: 信頼度（HIGH/MEDIUM/LOW）

【報告フォーマット（標準化）】
[PROGRESS] X/Y完了
[FINDING] 重要な発見の概要
[ANALYSIS] 分析結果と解釈
[RECOMMENDATIONS] 推奨事項
[QUALITY_SCORES] Coverage:XX, Accuracy:XX, Usability:XX
[CONFIDENCE] HIGH/MEDIUM/LOW
[DEPENDENCIES] 他エージェントとの関連性
[NEXT] 次のアクション
[STATUS] ACTIVE/WAITING/CHECKING

まず mcp__chat__agent_communication_enter_room で [room-name] ルームに参加してから調査を開始してください。
```

### Phase 1: 段階的調査実行（最適化版）

#### 1.1 段階的エージェント起動戦略
```bash
# Phase 1a: 基盤調査（並行起動）
Agent A: アーキテクチャ・構造調査
Agent D: ドキュメント・資料調査

# 完了確認後にPhase 1b
# Phase 1b: 専門調査（条件付き並行）
Agent B: 実装詳細・コード調査（A完了後）
Agent C: 設定・ルール調査（独立）
Agent E,F: 専門ディレクトリ調査（D完了後）

# 全完了後にPhase 1c
# Phase 1c: 統合作業
Agent G: 統合レポート作成（Opus）
```

#### 1.2 起動タイミング制御の実装
```bash
# 基盤エージェント起動
mcp__ccm__claude_code [Agent A prompt] &
mcp__ccm__claude_code [Agent D prompt] &

# 完了待機（適応的間隔）
sleep 120  # 初期2分待機
mcp__ccm__list_claude_processes  # 状況確認

# 条件分岐による次段階起動
if [基盤調査完了]; then
    mcp__ccm__claude_code [Agent B prompt] &
    mcp__ccm__claude_code [Agent C prompt] &
    # 追加専門エージェント（発見に応じて）
fi
```

#### 1.3 進捗監視とコラボレーション管理（最適化版）
```
監視間隔（適応的）:
- 初期段階: 2分間隔（起動直後の安定性確認）
- 中期段階: 3分間隔（安定稼働時）
- 後期段階: 5分間隔（長時間作業時）

レポート頻度: エージェントの5分毎自動報告
重要発見: 即座にチャット共有（緊急度分類）

コーディネーターの役割:
- 段階的進捗確認（効率的リソース管理）
- 新しい発見への対応
- 追加エージェントの必要性判断
- エージェント間の情報連携
- 待機時間の動的調整
```

#### 1.4 動的エージェント追加の判断基準
```
追加タイミング:
✓ 新しい重要ディレクトリ/ファイル群の発見
✓ 予想以上の複雑性や規模
✓ 特殊な技術領域の発見
✓ 既存エージェントの負荷過多

追加手順:
1. 新専門領域の特定
2. 専門エージェントプロンプト作成
3. mcp__ccm__claude_code で起動
4. Chat MCPルームへの参加確認
```

### Phase 2: 統合・検証・品質向上

#### 2.1 専門エージェント完了の確認
```bash
# 全エージェントの状況確認
mcp__ccm__list_claude_processes
mcp__chat__agent_communication_get_messages

# 完了判定基準
- 全エージェントからの "TASK_COMPLETED" 受信
- 各エージェントのstatus: "completed"
- 期待される成果物の生成確認
```

#### 2.2 統合エージェント（Opus）の起動
```
統合専門エージェント仕様:
- モデル: "opus"（高品質統合のため）
- 最大実行時間: 90分
- 入力: 全エージェントのチャット履歴 + 成果物
- 出力: 包括的統合レポート群

必須成果物テンプレート:
1. [task]-final-report.md - 全体統合レポート
2. [domain]-analysis-matrix.md - 詳細分析マトリックス
3. [task]-implementation-guide.md - 実装ガイド
4. [task]-workflow-diagram.md - フロー図・関係図
5. [task]-action-plan.md - 次のアクション計画
```

## エージェント設計のベストプラクティス

### 1. 専門性の明確化
```
良い例:
- Agent A: src/router/配下のルーティング実装専門
- Agent B: Vue/Nuxtコンポーネント構造専門
- Agent C: CASL権限システム実装専門

悪い例:
- Agent A: フロントエンド全般担当
- Agent B: バックエンド全般担当
```

### 2. 重複回避と連携設計
```
重複回避:
- ファイル/ディレクトリ担当を明確に分離
- 調査観点（構造 vs 実装 vs 設定）で分離

連携設計:
- 発見した関連情報の即座共有
- 依存関係の明確化
- 矛盾検出と解決メカニズム
```

### 3. モデル選択指針
```
Sonnet適用領域:
- 構造的分析（ディレクトリ構造、設定ファイル）
- パターン抽出（コード規約、命名規則）
- データ変換（CSV生成、マッピング作成）
- 定型的な調査タスク

Opus適用領域:
- 最終統合レポート作成
- 複雑な関係性の分析
- 戦略的な提案・改善案
- 品質重視の成果物作成
```

## Chat MCPコラボレーション管理

### 1. メッセージング規約
```
進捗報告フォーマット:
[PROGRESS] X/Y完了
[FINDING] 重要な発見
[NEXT] 次のアクション
[STATUS] ACTIVE/WAITING/CHECKING

重要発見の共有:
[URGENT] 緊急度の高い発見
[INFO] 他エージェントへの情報提供
[QUESTION] 他エージェントへの質問

コーディネーター指示:
status_[agent-id] - 状況確認要求
new_task_[agent-id] - 新タスク指示
terminate_[agent-id] - 終了指示
terminate_all - 全エージェント終了
```

### 2. 情報共有のタイミング
```
即座共有すべき発見:
- 新しい重要ディレクトリ/ファイル群
- 既存想定と大きく異なる構造
- 他エージェントに影響する情報
- セキュリティ関連の発見

定期報告内容:
- 調査進捗（X/Y完了）
- 主要な発見事項
- 次の調査予定
- 支援が必要な項目
```

## 成功事例: Permission調査システム

### 調査背景
```
課題: 
- URLごとの操作権限資料が見つからない
- 画面ごとの操作資料が散在
- 画面遷移関係が不明確

期待成果:
- 包括的権限資料の作成
- テスト実行可能な手順書
- 画面遷移フロー図
```

### エージェント構成の進化
```
初期設計（4エージェント）:
- Agent A: ルーティング・URL調査
- Agent B: 画面遷移・操作フロー調査
- Agent C: 権限実装調査
- Agent D: 資料統合調査

発見による拡張:
+ Agent E: docs/ディレクトリ専門調査
+ Agent F: test_cases/ディレクトリ専門調査
+ Agent G: 統合レポート作成（Opus）

総調査時間: 約20分（7エージェント並行）
```

### 成功要因
```
1. 適応的設計: 発見に応じた動的拡張
2. 継続実行: エージェントの自動終了防止
3. 専門化: 各エージェントの明確な役割分担
4. 品質統合: Opusによる高品質な最終成果物
5. 実用性重視: ユーザーニーズに直接対応する成果物
```

### 創出された価値
```
成果物（5ファイル）:
1. permission-investigation-final-report.md (7,546B)
2. screen-operation-matrix.md (9,473B) 
3. url-access-control-guide.md (9,214B)
4. screen-transition-flow.md (8,438B)
5. permission-test-execution-guide.md (10,946B)

従来手法との比較:
- 調査時間: 数日 → 20分
- 網羅性: 部分的 → 完全
- 品質: バラツキあり → 一定品質
- 実用性: 限定的 → 即座に使用可能
```

## 他の適用例

### 1. セキュリティ監査
```
エージェント構成:
- Agent A: 認証・認可システム調査
- Agent B: データ保護・暗号化調査
- Agent C: ネットワークセキュリティ調査
- Agent D: 脆弱性パターン調査
- Agent E: セキュリティポリシー・設定調査

期待成果物:
- セキュリティ監査レポート
- 脆弱性リスクマトリックス
- 改善アクションプラン
- セキュリティテスト手順書
```

### 2. パフォーマンス分析
```
エージェント構成:
- Agent A: フロントエンドパフォーマンス調査
- Agent B: バックエンドパフォーマンス調査
- Agent C: データベースパフォーマンス調査
- Agent D: ネットワーク・インフラ調査
- Agent E: 監視・ログ分析

期待成果物:
- パフォーマンス分析レポート
- ボトルネック特定結果
- 最適化実装ガイド
- 監視・測定手順書
```

### 3. アーキテクチャ分析
```
エージェント構成:
- Agent A: システム構成・依存関係調査
- Agent B: データフロー・API調査
- Agent C: UI/UXアーキテクチャ調査
- Agent D: インフラ・デプロイ調査
- Agent E: 設計文書・仕様書調査

期待成果物:
- システムアーキテクチャドキュメント
- 技術スタック分析レポート
- 改善・近代化提案
- 移行計画・ロードマップ
```

## エラー処理とトラブルシューティング

### 1. エージェント異常終了への対応
```bash
# プロセス状況確認
mcp__ccm__list_claude_processes

# 異常終了したエージェントの特定
# exitCode != 0 または status != "running"/"completed"

# 復旧手順
1. 異常終了の原因特定（ログ確認）
2. 同等機能エージェントの再起動
3. 失われた調査内容の補完
4. 他エージェントへの影響評価
```

### 2. Chat MCP通信エラー
```bash
# ルーム状況確認
mcp__chat__agent_communication_get_status

# 通信エラーの対処
1. ルーム再作成（別名で）
2. エージェントの新ルーム移行
3. 過去メッセージの復旧
```

### 3. リソース不足・タイムアウト
```
対処法:
1. 調査範囲の縮小・分割
2. 低優先度タスクの削除
3. 待機時間の延長
4. エージェント数の削減

予防策:
- 初期範囲設定を保守的に
- 段階的な拡張方針
- リソース使用量の継続監視
```

## タスク管理のベストプラクティス

### TodoWriteツールによる進捗管理
```
推奨タスク構造:
1. 環境準備・エージェント起動
2. [Agent-X] 専門調査実行
3. エージェント間コラボレーション管理
4. 統合エージェント起動・監視
5. 成果物品質確認・納品

各タスクの粒度:
- 大きすぎる: エージェント群の並行実行
- 適切: 各エージェントの個別管理
- 小さすぎる: 個別ファイルの調査
```

### 進捗可視化
```
状況サマリーの定期更新:
✅ 完了エージェント数 / 総エージェント数
🔄 進行中の主要タスク
⚠️ 問題・ブロッカー
📊 成果物生成状況
⏱️ 残り推定時間
```

## ワークフローの拡張可能性

### 1. 自動化レベルの向上
```
現状: 手動監視・判断
改善1: 異常検知の自動化
改善2: エージェント追加の自動判断
改善3: 成果物品質の自動評価
```

### 2. ドメイン特化テンプレート
```
業界別テンプレート:
- 金融システム監査
- 医療システム調査
- ECサイト分析
- SaaS製品評価

技術別テンプレート:
- React/Vue.js アプリ調査
- Node.js/Python API分析
- AWS/GCP インフラ調査
- Docker/Kubernetes 環境分析
```

### 3. 外部ツール統合
```
発展可能性:
- CI/CD パイプライン統合
- 監視システム連携
- プロジェクト管理ツール連携
- ナレッジベース自動更新
```

## 品質保証指針

### 1. 成果物品質基準
```
必須要件:
✓ 実用性: 即座に使用可能
✓ 完全性: 調査対象の全領域カバー
✓ 正確性: 事実に基づく正確な情報
✓ 構造化: 論理的で読みやすい構成
✓ 実行可能性: 具体的なアクション指針

品質チェックポイント:
- 専門エージェントの成果物相互チェック
- Opus統合エージェントによる品質向上
- 最終成果物の実用性検証
```

### 2. プロセス品質管理
```
監視指標:
- エージェント稼働率（目標: 95%以上）
- タスク完了率（目標: 100%）
- 成果物生成率（目標: 期待ファイル100%）
- 調査網羅率（目標: 対象領域100%）

改善サイクル:
1. 実行結果の振り返り
2. 問題点・改善点の特定
3. プロセス・プロンプトの改良
4. 次回適用での検証
```

## コスト最適化

### 1. モデル選択最適化
```
コスト効率の原則:
- Sonnet: 構造的・定型的調査（70%）
- Opus: 複雑分析・統合作業（30%）

具体的配分例（7エージェント）:
- 専門調査（A-F）: Sonnet × 6
- 統合作業（G）: Opus × 1
- コスト比: 約 1:2 の配分
```

### 2. 実行時間最適化（改良版）
```
効率化手法:
- 段階的並行実行（2→4→6エージェント）
- 適応的待機時間（2分→3分→5分）
- 依存関係を考慮した起動順序
- 調査範囲の事前明確化
- リソース競合の回避

具体的実装:
# Phase 1a: 基盤調査（2エージェント）
sleep 120  # 2分待機
# Phase 1b: 専門調査（4エージェント追加）
sleep 180  # 3分待機
# Phase 1c: 統合作業（1エージェント追加）
sleep 300  # 5分待機

目標実行時間（最適化後）:
- 小規模調査: 8-12分（20%短縮）
- 中規模調査: 15-25分（25%短縮）  
- 大規模調査: 35-50分（22%短縮）
```

## 注意事項

### 1. リソース管理
```
同時実行制限:
- 最大エージェント数: 8個まで
- Opusエージェント: 同時1個まで
- メモリ使用量の監視
- Chat MCPメッセージ数の管理
```

### 2. セキュリティ考慮事項
```
情報保護:
- 機密情報を含むファイルの除外
- Chat MCPログの適切な管理
- 成果物の機密レベル分類
- 外部共有時の注意事項
```

### 3. 運用上の制約
```
制限事項:
- ネットワーク接続の依存性
- APIレート制限の影響
- ローカルリソースの制約
- 長時間実行時の安定性
```

## 最適化による改善効果

### 実装済み改善の期待効果
```
✅ 段階的エージェント起動:
- 実行時間: 10-15% 短縮
- リソース効率: 20-30% 向上
- システム安定性: 大幅向上

✅ 適応的監視間隔:
- 通信負荷: 40-50% 削減
- 監視効率: 25% 向上

✅ プロンプト品質標準化:
- 成果物品質: 15-20% 向上
- 統合作業効率: 30% 向上
- 一貫性: 85% 向上

総合改善効果:
- 実行時間: 20-25% 短縮
- コスト効率: 15-20% 向上
- 品質一貫性: 大幅向上
- システム安定性: 大幅向上
```

### 適用前後の比較
```
従来版:
- 7エージェント一斉起動
- 1分間隔固定監視
- 実行時間: 20分
- リソース競合リスク: 高

最適化版:
- 段階的起動（2→4→1）
- 適応的監視（2→3→5分）
- 実行時間: 15-17分
- リソース競合リスク: 低
```

## まとめ

このワークフローは、複雑な調査・分析タスクを複数のAIエージェントで効率的に実行するための包括的なフレームワークです。適応的な設計、継続実行の保証、品質の高い統合により、従来の手動調査では困難な規模と品質の成果物を短時間で創出できます。

**最適化された核心的価値**: 
- 人間の認知負荷軽減（段階的管理により）
- 調査品質の標準化・向上（品質メトリクス導入）
- 作業時間の大幅短縮（20-25%の効率向上）
- 再利用可能な知識の蓄積
- システム安定性の向上（リソース競合回避）

このワークフローを活用することで、複雑なシステムやプロジェクトの理解促進、意思決定支援、品質向上を実現できます。